// Code generated by hertz generator.

package main

import (
	"context"
	"github.com/cloudwego/hertz/pkg/app/server"
	"github.com/cloudwego/hertz/pkg/common/hlog"
	hertzlogrus "github.com/hertz-contrib/obs-opentelemetry/logging/logrus"
	"github.com/hertz-contrib/obs-opentelemetry/provider"
	hertztracing "github.com/hertz-contrib/obs-opentelemetry/tracing"
	"net"
	"os"
	"sheepim-api-gateway/biz/infra/container"
	"sheepim-api-gateway/biz/infra/log"
)

func main() {
	env := os.Getenv("ENV")
	if env == "" {
		env = "development"
	}
	container.InitGlobalContainer(env)
	log.InitLog()
	App := container.GetGlobalContainer()

	serviceName := App.Config.ServerConfig.ServiceName
	addr, err := net.ResolveTCPAddr("tcp", App.Config.ServerConfig.ListenAddress)
	if err != nil {
		panic("设置监听地址出错")
	}

	p := provider.NewOpenTelemetryProvider(
		provider.WithServiceName(serviceName),
		provider.WithExportEndpoint(App.Config.OpenTelemetryConfig.Endpoint),
		provider.WithInsecure(),
	)
	hlog.SetLogger(hertzlogrus.NewLogger())
	defer func(p provider.OtelProvider, ctx context.Context) {
		err := p.Shutdown(ctx)
		if err != nil {
			hlog.Fatalf("server stopped with error:%s", err)
		}
	}(p, context.Background())
	tracer, cfg := hertztracing.NewServerTracer()
	h := server.Default(tracer,
		server.WithHostPorts(addr.String()),
	)

	h.Use(hertztracing.ServerMiddleware(cfg))

	register(h)
	h.Spin()
}
